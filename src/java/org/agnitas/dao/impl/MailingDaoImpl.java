/*********************************************************************************
 * The contents of this file are subject to the Common Public Attribution
 * License Version 1.0 (the "License"); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 * http://www.openemm.org/cpal1.html. The License is based on the Mozilla
 * Public License Version 1.1 but Sections 14 and 15 have been added to cover
 * use of software over a computer network and provide for limited attribution
 * for the Original Developer. In addition, Exhibit A has been modified to be
 * consistent with Exhibit B.
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for
 * the specific language governing rights and limitations under the License.
 *
 * The Original Code is OpenEMM.
 * The Original Developer is the Initial Developer.
 * The Initial Developer of the Original Code is AGNITAS AG. All portions of
 * the code written by AGNITAS AG are Copyright (c) 2007 AGNITAS AG. All Rights
 * Reserved.
 *
 * Contributor(s): AGNITAS AG.
 ********************************************************************************/

package org.agnitas.dao.impl;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.sql.DataSource;

import org.agnitas.beans.Mailing;
import org.agnitas.beans.MailingBase;
import org.agnitas.beans.MailingComponent;
import org.agnitas.beans.Mailinglist;
import org.agnitas.beans.Mediatype;
import org.agnitas.beans.TrackableLink;
import org.agnitas.beans.impl.PaginatedListImpl;
import org.agnitas.beans.impl.MailingBaseImpl;
import org.agnitas.beans.impl.MailinglistImpl;
import org.agnitas.dao.MailingDao;
import org.agnitas.dao.TrackableLinkDao;
import org.agnitas.util.AgnUtils;
import org.displaytag.pagination.PaginatedList;
import org.hibernate.SessionFactory;
import org.springframework.context.ApplicationContext;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.orm.hibernate3.HibernateTemplate;

/**
 *
 * @author mhe, Nicole Serek
 */
public class MailingDaoImpl implements MailingDao {


	protected DataSource dataSource;

	public Mailing getMailing(int mailingID, int companyID) {
        Mailing mailing = null;
        HibernateTemplate tmpl = new HibernateTemplate((SessionFactory)this.applicationContext.getBean("sessionFactory"));

        mailing = (Mailing)AgnUtils.getFirstResult(tmpl.find("from Mailing where id = ? and companyID = ? and deleted <> 1", new Object [] {new Integer(mailingID), new Integer(companyID)} ));
        if(mailing != null) {
            Map<Integer, Mediatype> map = mailing.getMediatypes();
            Iterator<Integer> it = map.keySet().iterator();

            while(it.hasNext()) {
                Integer key = it.next();

                if(map.get(key) instanceof org.agnitas.beans.impl.MediatypeImpl) {
                    Mediatype mt = null;
                    Mediatype src = (Mediatype) map.get(key);

                    switch(key.intValue()) {
                        case 0: mt = (Mediatype) this.applicationContext.getBean("MediatypeEmail");
                                break;
                        case 1: mt = (Mediatype) this.applicationContext.getBean("MediatypeFax");
                                break;
                        case 2: mt = (Mediatype) this.applicationContext.getBean("MediatypePrint");
                                break;
                        case 3: mt = (Mediatype) this.applicationContext.getBean("MediatypeMMS");
                                break;
                        case 4: mt = (Mediatype) this.applicationContext.getBean("MediatypeSMS");
                                break;
                        default: mt = (Mediatype) this.applicationContext.getBean("Mediatype");
                    }
                    mt.setPriority(src.getPriority());
                    mt.setStatus(src.getStatus());
                    try {
                        mt.setParam(src.getParam());
                    } catch(Exception e) {
                        AgnUtils.logger().error("Exception: "+e);
                        AgnUtils.logger().error(AgnUtils.getStackTrace(e));

                    }
                    map.put(key, mt);
                }
            }
        }
        return mailing;
    }

    public int saveMailing(Mailing mailing) {
        int result = 0;

        MailingBase tmpMailing = null;
        HibernateTemplate tmpl = new HibernateTemplate((SessionFactory)this.applicationContext.getBean("sessionFactory"));

        if(mailing.getId()!=0) {
        	System.err.println("Clearing mailing");
            tmpMailing = (MailingBase) AgnUtils.getFirstResult(tmpl.find("from Mailing where id = ? and companyID = ? and deleted <> 1", new Object [] {new Integer(mailing.getId()), new Integer(mailing.getCompanyID())} ));
            if(tmpMailing == null) {
                mailing.setId(0);
            }
        }

        Map<Integer, Mediatype> map = mailing.getMediatypes();
        Map<Integer, Mediatype> dst = new HashMap<Integer, Mediatype>();
        Iterator<Integer> i = map.keySet().iterator();

        while(i.hasNext()) {
            Integer idx = i.next();
            Mediatype mt = (Mediatype) map.get(idx);
            Mediatype tgt = (Mediatype) this.applicationContext.getBean("Mediatype");

            try {
                tgt.setPriority(mt.getPriority());
                tgt.setStatus(mt.getStatus());
                tgt.setParam(mt.getParam());
            } catch(Exception e) {
                AgnUtils.logger().error("Exception "+e);
                AgnUtils.logger().error(AgnUtils.getStackTrace(e));
            }
            dst.put(idx, tgt);
        }
        mailing.setMediatypes(dst);

        JdbcTemplate jdbc = AgnUtils.getJdbcTemplate(this.applicationContext);
        Map<String, MailingComponent> components = mailing.getComponents();
        Iterator<String> iter = components.keySet().iterator();
        while (iter.hasNext()) {
			MailingComponent entry = components.get(iter.next());

			if( entry.getType() == MailingComponent.TYPE_IMAGE || entry.getType() == MailingComponent.TYPE_ATTACHMENT || entry.getType() == MailingComponent.TYPE_HOSTED_IMAGE ) {
					entry.setEmmBlock(null);
			}

			if (entry.getType() != 0) {
				if (entry.getLink() != null && !entry.getLink().equals("")) {
//					Map trackableLinks = new HashMap();
					TrackableLinkDao linkDao = (TrackableLinkDao) applicationContext.getBean("TrackableLinkDao");
					TrackableLink trkLink = null;
					trkLink = linkDao.getTrackableLink(entry.getLink(), entry.getCompanyID(), mailing.getId());
					if(trkLink == null) {
						trkLink = (TrackableLink) applicationContext.getBean("TrackableLink");
					}
					trkLink.setCompanyID(entry.getCompanyID());
					trkLink.setFullUrl(entry.getLink());
					trkLink.setMailingID(mailing.getId());
					trkLink.setUsage(TrackableLink.TRACKABLE_TEXT_HTML);
					trkLink.setActionID(0);
					linkDao.saveTrackableLink(trkLink);

					String sql = "select url_id from rdir_url_tbl where mailing_id = ? and company_id = ? and full_url = ?";
					int id = jdbc.queryForInt(sql,new Object[] { new Integer(mailing.getId()), new Integer(entry.getCompanyID()), entry.getLink() });
					entry.setUrlID(id);
				}
			}
        }

        tmpl.saveOrUpdate("Mailing", mailing);
        result=mailing.getId();
        tmpl.flush();
        return result;
    }

    public boolean deleteMailing(int mailingID, int companyID) {
        Mailing tmpMailing = null;
        HibernateTemplate tmpl = new HibernateTemplate((SessionFactory)this.applicationContext.getBean("sessionFactory"));

        tmpMailing = this.getMailing(mailingID, companyID);
        if(tmpMailing == null) {
            return false;
        }

        tmpMailing.setDeleted(1);
        tmpl.flush();

        return true;
    }

    public List getMailingsForMLID(int companyID, int mailinglistID) {
        HibernateTemplate tmpl = new HibernateTemplate((SessionFactory)this.applicationContext.getBean("sessionFactory"));
        return tmpl.find("from Mailing where companyID = ? and mailinglistID = ? and deleted = 0", new Object [] {new Integer(companyID), new Integer(mailinglistID)} );
    }

    public Map<String, String> loadAction(int mailingID, int companyID) {
        Map<String, String> actions = new HashMap<String, String>();
        JdbcTemplate jdbc = new JdbcTemplate((DataSource) applicationContext.getBean("dataSource"));

    	String stmt = "select action_id, shortname, full_url from rdir_url_tbl where mailing_id = ? and company_id = ?";
    	try {
    		List list = jdbc.queryForList(stmt, new Object[] {new Integer(mailingID), new Integer(companyID)});
    		for(int i = 0; i < list.size(); i++) {
                Map map = (Map) list.get(i);
                int action_id = ((Number) map.get("action_id")).intValue();
                if(action_id > 0) {
                	stmt = "select shortname from rdir_action_tbl where company_id = ? and action_id = ?";
                	String action_short = (String) jdbc.queryForObject(stmt, new Object[]{ companyID, action_id }, stmt.getClass());

                	String name = "";
                	if(map.get("shortname") != null) {
                		name = (String) map.get("shortname");
                	} else {
                		name = (String) map.get("full_url");
                	}
                	actions.put(action_short, name);
                }
    		}
    	} catch (Exception e) {
    		AgnUtils.sendExceptionMail("sql:" + stmt + ", " + mailingID + ", " + companyID, e);
    		System.err.println(e.getMessage());
    		System.err.println(AgnUtils.getStackTrace(e));
    	}
        return actions;
    }

    public boolean deleteContentFromMailing(MailingBase mailing, int contentID){
    	JdbcTemplate jdbcTemplate = AgnUtils.getJdbcTemplate(this.applicationContext);
    	String deleteContentSQL = "DELETE from dyn_content_tbl WHERE dyn_content_id = ? AND company_id = ?";

    	Object[] params = new Object[]{new Integer(contentID), 1};
    	int affectedRows = 0;
    	affectedRows = jdbcTemplate.update(deleteContentSQL, params );
    	return affectedRows > 0;
    }


	/**
	 * Build an SQL-expression from th egiven target_expression.
	 * The expression is a list of targetIDs connected with the operators:
	 * <ul>
	 * <li>( - block start
	 * <li>) - block end
	 * <li>&amp; - AND
	 * <li>| - OR
	 * <li>! - NOT
	 * </ul>
	 * @param targetExpression The expression as string.
	 * @param jdbc Template for SQL queries.
	 * @return the resulting where clause.
	 */
	static String getSQLExpression(String targetExpression, JdbcTemplate jdbc)	{
		StringBuffer buf = new StringBuffer ();
		int	tlen = targetExpression.length ();

		if (targetExpression == null) {
			return null;
		}
		for (int n = 0; n < tlen; ++n) {
			char ch = targetExpression.charAt (n);

			if ((ch == '(') || (ch == ')')) {
				buf.append (ch);
			} else if ((ch == '&') || (ch == '|')) {
				if (ch == '&')
					buf.append (" AND");
				else
					buf.append (" OR");
				while (((n + 1) < tlen) && (targetExpression.charAt (n + 1) == ch))
					++n;
			} else if (ch == '!') {
				buf.append (" NOT");
			} else if (Character.isDigit(ch)) {
				String	temp = "";
				int	first = n;
				int	tid = (-1);

				while(n < tlen && Character.isDigit(ch)) {
					n++;
				}
				tid=Integer.parseInt(targetExpression.substring(first, n));
				temp = (String) jdbc.queryForObject("select target_sql from dyn_target_tbl where target_id = ?", new Object[] {new Integer(tid)}, temp.getClass());
				if (temp != null && temp.trim().length() > 2)
					buf.append(" (" + temp + ")");
			}
		}
		if (buf.length () >= 3)
			return buf.toString ();
		return null;
	}

	/**
	 * Finds the last newsletter that would have been sent to the given
	 * customer.
	 * @param customerID Id of the recipient for the newsletter.
	 * @param companyID the company to look in.
	 * @return The mailingID of the last newsletter that would have been
	 *              sent to this recipient.
	 */
	public int	findLastNewsletter(int customerID, int companyID, int mailinglist) {
		JdbcTemplate jdbc = new JdbcTemplate((DataSource) applicationContext.getBean("dataSource"));
		String	sql="select m.mailing_id, m.target_expression, a."+AgnUtils.changeDateName()+" from mailing_tbl m left join mailing_account_tbl a ON a.mailing_id=m.mailing_id where m.company_id=? and m.deleted<>1 and m.is_template=0 and a.status_field='W' and m.mailinglist_id=? order by a."+AgnUtils.changeDateName()+" desc, m.mailing_id desc";

		try {
			List list = jdbc.queryForList(sql, new Object[] {new Integer(companyID), new Integer(mailinglist)});

			for(int i = 0; i < list.size(); i++) {
				Map map = (Map) list.get(i);
				int mailing_id = ((Number) map.get("mailing_id")).intValue();
				String targetExpression = (String) map.get("target_expression");

				if(targetExpression == null || targetExpression.trim().length() == 0) {
					return mailing_id;
				}
				sql="select count(*) from customer_" + companyID + "_tbl cust where " + getSQLExpression(targetExpression, jdbc) + " and customer_id=?";
System.err.println("SQL: "+sql);
				if(jdbc.queryForInt(sql, new Object[]{ customerID }) > 0) {
					return mailing_id;
				}
                	}
		} catch (Exception e) {
			System.err.println(e.getMessage());
			System.err.println(AgnUtils.getStackTrace(e));
		}
		return 0;
	}

	public String[]	getTag(String name, int companyID) {
        JdbcTemplate jdbc = new JdbcTemplate((DataSource) applicationContext.getBean("dataSource"));
		String sql = "select selectvalue, type from tag_tbl where tagname=? and (company_id=0 or company_id=?)";
		String[] result = null;

		try {
			List list=jdbc.queryForList(sql, new Object[]{name, new Integer(companyID)});

			if(list.size() > 0) {
				Map map = (Map) list.get(0);

				result = new String[]{ (String) map.get("selectvalue"), (String) map.get("type") };
			}
		} catch (Exception e) {
			AgnUtils.sendExceptionMail("sql:" + sql + ", "+ name + ", " + companyID, e);
			AgnUtils.logger().error("processTag: "+e.getMessage());
			result = null;
		}
		return result;
	}

	public String	getAutoURL(int mailingID)	{
        JdbcTemplate jdbc = new JdbcTemplate((DataSource) applicationContext.getBean("dataSource"));
		String	sql="select auto_url from mailing_tbl where mailing_id=?";

		try	{
			return (String) jdbc.queryForObject(sql, new Object[]{new Integer(mailingID)}, sql.getClass());
		} catch(Exception e) {
			AgnUtils.logger().error("getAutoURL: "+e.getMessage());
		}
		return null;
	}

	public String getAutoURL(int mailingID, int companyID) {
		JdbcTemplate jdbc = new JdbcTemplate((DataSource) applicationContext.getBean("dataSource"));
		String rdirdomain = null;
		String rdir_mailinglistquery = "select  ml.RDIR_DOMAIN  FROM MAILINGLIST_TBL ml JOIN MAILING_TBL m ON ( ml.MAILINGLIST_ID = m.MAILINGLIST_ID) WHERE  m.MAILING_ID=?";
		rdirdomain = (String) jdbc.queryForObject(rdir_mailinglistquery, new Object[]{new Integer(mailingID)}, String.class );
		if( rdirdomain != null ) {
			return rdirdomain;
		}
		String rdir_companyquery = "select RDIR_DOMAIN FROM COMPANY_TBL where company_id=?";
		rdirdomain = (String) jdbc.queryForObject(rdir_companyquery, new Object[]{new Integer(companyID)}, String.class );
			return rdirdomain;
	}

    /**
     * Holds value of property applicationContext.
     */
    protected ApplicationContext applicationContext;

    /**
     * Setter for property applicationContext.
     * @param applicationContext New value of property applicationContext.
     */
    public void setApplicationContext(ApplicationContext applicationContext) {

        this.applicationContext = applicationContext;
    }

	public PaginatedList getMailingList( int companyID, String types,
			boolean isTemplate, String sort, String direction, int page, int rownums)  {

	      JdbcTemplate aTemplate = new JdbcTemplate((DataSource) applicationContext.getBean("dataSource"));
	      List<String>  charColumns = Arrays.asList(new String[]{"shortname","description","mailinglist" });

	      int offset =  ( page - 1) * rownums;

	      String mailingTypes = "  AND  mailing_type in ("+ types +") ";
	      if(isTemplate) {
	     		mailingTypes = " ";
	      }

	    String orderby = null;
		String defaultorder = " send_null ASC, senddate DESC, mailing_id DESC  ";
		if( sort != null && ! "".equals(sort.trim())) {
			orderby = getUpperSort(charColumns, sort);
			orderby = orderby + " " +direction;
		}
		else {
			orderby = defaultorder;
		}

		String sqlStatement =
	    	  " SELECT *, case when senddate is null then 0 else 1 end as send_null " +
	    	  " FROM (   SELECT a.mailing_id , a.shortname  , a.description ,   min(c." + AgnUtils.changeDateName() + ") senddate, m.shortname mailinglist " +
	    	  " FROM  (mailing_tbl  a LEFT JOIN mailing_account_tbl c ON (a.mailing_id=c.mailing_id AND c.status_field='W')) " + " LEFT JOIN mailinglist_tbl m ON (  a.mailinglist_id=m.mailinglist_id AND  a.company_id=m.company_id) " +
			  "  WHERE a.company_id = ? AND a.deleted<>1 AND a.is_template=?"
				+ mailingTypes + "  GROUP BY  a.mailing_id, a.shortname, a.description, m.shortname ) openemm ORDER BY " + orderby;


	     int totalsize = aTemplate.queryForInt("select count(*) from ( " +sqlStatement + ") agn", new Object[]{ companyID, (isTemplate?1:0) });

	     sqlStatement = sqlStatement + " LIMIT " + offset + " , " + rownums;

	     List<Map> tmpList = aTemplate.queryForList(sqlStatement, new Object[]{ companyID, (isTemplate?1:0) });

	      List<MailingBase> result = new ArrayList<MailingBase>();
	      for(Map row:tmpList) {

			  MailingBase newBean = new MailingBaseImpl();

              int mailingID = ((Number) row.get("MAILING_ID")).intValue();
              newBean.setId(mailingID);
	    	  newBean.setShortname((String) row.get("SHORTNAME"));
	    	  newBean.setDescription( (String) row.get("DESCRIPTION"));

	    	  Mailinglist mailinglist = new MailinglistImpl();
	    	  mailinglist.setShortname( (String) row.get("MAILINGLIST"));

	    	  newBean.setMailinglist(mailinglist);
	    	  newBean.setSenddate((Date) row.get("SENDDATE"));
              if (hasActions(mailingID, companyID))
                  newBean.setHasActions(Boolean.TRUE);

	    	  result.add(newBean);

	      }

	      PaginatedListImpl paginatedList = new PaginatedListImpl(result, totalsize, rownums, page, sort, direction);

	      return paginatedList;
	}

	protected String getUpperSort(List<String> charColumns, String sort) {
		String upperSort = sort;
		if (charColumns.contains( sort )) {
	    	upperSort = "upper( " +sort + " )";
	     }
		return upperSort;
	}

	public String getFormat(int type) {
		String format = "d.M.yyyy";
		JdbcTemplate jdbc = new JdbcTemplate((DataSource) applicationContext.getBean("dataSource"));
		try {
            String sql = "SELECT format FROM date_tbl WHERE type = ?";
            format = (String) jdbc.queryForObject(sql, new Object[] {new Integer(type)}, String.class);
        } catch (Exception e) {
        	AgnUtils.logger().error("Query failed for data_tbl: " + e);
        }
		return format;
	}



	public int getStatusidForWorldMailing(int mailingID, int companyID) {
		int returnValue = 0;
		JdbcTemplate jdbcTemplate = new JdbcTemplate( dataSource );
		String query = "SELECT status_id  FROM maildrop_status_tbl  WHERE company_id="+companyID+" and mailing_id="+mailingID+" and status_field='W' and genstatus=3 and senddate < now()";
		try {
			returnValue = jdbcTemplate.queryForInt(query);
		} catch (Exception e) {
			returnValue = 0;
		}
		return returnValue;

	}

	@Override
	public int getGenstatusForWorldMailing(int mailingID) throws Exception {
		JdbcTemplate jdbcTemplate = new JdbcTemplate( dataSource );
		String query = "SELECT genstatus  FROM maildrop_status_tbl  WHERE mailing_id= ? and status_field='W' ";
		return jdbcTemplate.queryForInt(query, new Object[]{mailingID});

	}




	public void setDataSource(DataSource dataSource) {
			this.dataSource = dataSource;
	 }

	public boolean hasPreviewRecipients(int mailingID, int companyID) {
		JdbcTemplate template = new JdbcTemplate(dataSource);
		String query = "SELECT DISTINCT 1 FROM mailing_tbl m, mailinglist_tbl ml, customer_" + companyID + "_binding_tbl c WHERE c.user_type in ('A', 'T') AND c.mailinglist_id = ml.mailinglist_id AND ml.company_id = " + companyID + " AND m.mailinglist_id = ml.mailinglist_id AND m.mailing_id = " + mailingID + " AND m.company_id = " + companyID + " AND c.user_status = 1";

		try {
			template.queryForInt(query);
			return true;
		} catch (Exception e) {
			return false;
		}
	}

    public HashMap<Integer, Integer> getAllMailingsOnTheSystem() {
        return null;
    }

	@Override
	public boolean isTransmissionRunning(int mailingID) {
		return true;
	}

    public boolean hasActions(int mailingId, int companyID) {
        JdbcTemplate jdbc = new JdbcTemplate((DataSource) applicationContext.getBean("dataSource"));
    	String stmt = "select count(action_id) from rdir_url_tbl where mailing_id = ? and company_id = ? and action_id != 0";
    	try {
    		Integer count = jdbc.queryForInt(stmt, new Object[] {new Integer(mailingId), new Integer(companyID)});
            return count > 0;
    	} catch (Exception e) {
    		AgnUtils.sendExceptionMail("sql:" + stmt + ", " + mailingId + ", " + companyID, e);
    		System.err.println(e.getMessage());
    		System.err.println(AgnUtils.getStackTrace(e));
    	}
        return false;
    }

    @Override
    public boolean cleanupContentForDynName(int mailingID, String dynName, int companyID) {
        // do nothing because Hibernate will manage these beans
        return false;
    }

}
